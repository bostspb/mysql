# Базы данных
> **Geek University Data Engineering**

`MySQL` `MongoDB` `Redis` `Docker` `Python:PyMySql` `Python:Facker`

_В данном курсе были выполнены следующие задания и [курсовая работа](#курсовая-работа)._

## Уроки 1 и 2. Установка окружения. DDL-команды. Управление БД. Язык запросов SQL
1. Установите СУБД `MySQL`. Создайте в домашней директории файл `.my.cnf`, 
задав в нем логин и пароль, который указывался при установке.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson02/task01.sql)

2. Создайте базу данных `example`, разместите в ней таблицу users, 
состоящую из двух столбцов, числового id и строкового name.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson02/task02.sql)

3. Создайте дамп базы данных `example` из предыдущего задания, 
разверните содержимое дампа в новую базу данных `sample`.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson02/task03.sql)

4. (по желанию) Ознакомьтесь более подробно с документацией утилиты `mysqldump`. 
Создайте дамп единственной таблицы `help_keyword` базы данных `mysql`. 
Причем добейтесь того, чтобы дамп содержал только первые 100 строк таблицы.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson02/task04.sql)


## Урок 3. Введение в проектирование БД
1. Проанализировать структуру БД `vk`, которую мы создали на занятии, 
и внести предложения по усовершенствованию (если такие идеи есть). 
Напишите пожалуйста, всё-ли понятно по структуре.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson03/task01.sql)

2. Добавить необходимую таблицу/таблицы для того, чтобы можно 
было использовать лайки для медиафайлов, постов и пользователей.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson03/task02.sql)

3. Используя сервис http://filldb.info или другой по вашему желанию, 
сгенерировать тестовые данные для всех таблиц, учитывая логику связей. 
Для всех таблиц, где это имеет смысл, создать не менее 100 строк. 
Создать локально БД `vk` и загрузить в неё тестовые данные.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson03/task_extended_03.sql)

4. (1*) Реализовать подобную БД но на `PostgreSQL`, 
используя специфичные для этой субд типы данных

5. (2*) Реализовать древовидные комментарии к постам (как в vk.com)<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson03/task_extended_02.sql)

6. (3*) Сгенерировать данные не с помощью сервисов, 
а используя знакомые языки программирования 
либо соответствующую функциональность в фреймворках<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson03/task_extended_03.py)


## Урок 4. CRUD-операции
1. Повторить все действия по доработке БД `vk`.

2. Заполнить новые таблицы.

3. Повторить все действия CRUD.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson04/task03.sql)

4. Подобрать сервис-образец для курсовой работы.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson04/task04.sql)

5. (1*) Выполнить CRUD операции, аналогичные сделанным на уроке, 
но с типами данных `array` и `json` (и/или другими интересными для вас 
типами данных: `uuid`, сетевые адреса, `xml`, геоданные)<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson04/task_extended_01.sql)


## Урок 5. Операторы, фильтрация, сортировка и ограничение. Агрегация данных
1. Пусть в таблице `users` поля `created_at` и `updated_at` оказались незаполненными. 
Заполните их текущими датой и временем.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson05/task_03_01.sql)

2. Таблица `users` была неудачно спроектирована. 
Записи `created_at` и `updated_at` были заданы типом `VARCHAR` и
в них долгое время помещались значения в формате `20.10.2017 8:10`. 
Необходимо преобразовать поля к типу `DATETIME`, 
сохранив введённые ранее значения.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson05/task_03_02.sql)

3. В таблице складских запасов `storehouses_products` в поле `value` 
могут встречаться самые разные цифры: 0, если товар закончился 
и выше нуля, если на складе имеются запасы. <br>
Необходимо отсортировать записи таким образом, 
чтобы они выводились в порядке увеличения значения `value`. <br>
Однако нулевые запасы должны выводиться в конце, после всех записей.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson05/task_03_03.sql)

4. (по желанию) Из таблицы `users` необходимо извлечь пользователей, 
родившихся в августе и мае. Месяцы заданы в виде списка английских 
названий (may, august)<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson05/task_03_04.sql)

5. (по желанию) Из таблицы catalogs извлекаются записи при помощи запроса. <br>
`SELECT * FROM catalogs WHERE id IN (5, 1, 2); `<br>
Отсортируйте записи в порядке, заданном в списке `IN`.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson05/task_03_05.sql)

6. Подсчитайте средний возраст пользователей в таблице `users`.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson05/task_04_01.sql)

7. Подсчитайте количество дней рождения, 
которые приходятся на каждый из дней недели. 
Следует учесть, что необходимы дни недели текущего года, 
а не года рождения.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson05/task_04_01.sql)
 
8. (по желанию) Подсчитайте произведение чисел в столбце таблицы.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson05/task_04_02.sql)
 
 
## Урок 6. Операторы, фильтрация, сортировка и ограничение. Агрегация данных
1. Проанализировать запросы, которые выполнялись на занятии, 
определить возможные корректировки и/или улучшения (`JOIN` пока не применять).<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson06/task01.sql)

2. Пусть задан некоторый пользователь. 
Из всех друзей этого пользователя найдите человека, 
который больше всех общался с нашим пользователем.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson06/task02.sql)

3. Подсчитать общее количество лайков, которые получили 10 самых молодых пользователей.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson06/task03.sql)

4. Определить кто больше поставил лайков (всего) - мужчины или женщины?<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson06/task04.sql)

5. Найти 10 пользователей, которые проявляют наименьшую активность в использовании социальной сети.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson06/task05.sql)


## Уроки 7 и 8. Сложные запросы
1. Составьте список пользователей `users`, 
которые осуществили хотя бы один заказ orders в интернет магазине.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson07/task01.sql)
 
2. Выведите список товаров `products` и разделов `catalogs`, 
который соответствует товару.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson07/task02.sql)
 
3. (по желанию) Пусть имеется таблица рейсов `flights (id, from, to)` и таблица городов `cities (label, name)`. 
Поля `from`, `to` и `label` содержат английские названия городов, поле name — русское.
Выведите список рейсов `flights` с русскими названиями городов.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson07/task03.sql)


## Уроки 9 и 10. Транзакции, переменные, представления. Администрирование. Хранимые процедуры и функции, триггеры
1. В базе данных `shop` и `sample` присутствуют одни и те же таблицы, учебной базы данных. 
Переместите запись `id = 1` из таблицы `shop.users` в таблицу `sample.users`. 
Используйте транзакции.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson09/task06_01.sql)

2. Создайте представление, которое выводит название `name` товарной позиции 
из таблицы `products` и соответствующее название каталога name из таблицы `catalogs`.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson09/task06_02.sql)

3. (по желанию) Пусть имеется таблица с календарным полем created_at. 
В ней размещены разряженые календарные записи за август 2018 года '2018-08-01', '2016-08-04', '2018-08-16' и 2018-08-17.  
Составьте запрос, который выводит полный список дат за август, выставляя в соседнем поле значение 1, 
если дата присутствует в исходном таблице и 0, если она отсутствует.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson09/task06_03.sql)

4. (по желанию) Пусть имеется любая таблица с календарным полем `created_at`. 
Создайте запрос, который удаляет устаревшие записи из таблицы, оставляя только 5 самых свежих записей.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson09/task06_04.sql)

5. Создайте двух пользователей которые имеют доступ к базе данных `shop`. 
Первому пользователю `shop_read` должны быть доступны только запросы на чтение данных,  
второму пользователю `shop` — любые операции в пределах базы данных `shop`.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson09/task07_01.sql)

6. (по желанию) Пусть имеется таблица `accounts` содержащая три столбца `id`, `name`, `password`, 
содержащие первичный ключ, имя пользователя и его пароль. 
Создайте представление `username` таблицы `accounts`, предоставляющий доступ к столбца `id` и `name`.
Создайте пользователя `user_read`, который бы не имел доступа к таблице `accounts`, однако, 
мог бы извлекать записи из представления `username`.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson09/task07_02.sql)

7. Создайте хранимую функцию `hello()`, которая будет возвращать приветствие, 
в зависимости от текущего времени суток. 
С 6:00 до 12:00 функция должна возвращать фразу "Доброе утро", 
с 12:00 до 18:00 функция должна возвращать фразу "Добрый день", 
с 18:00 до 00:00 — "Добрый вечер", 
с 00:00 до 6:00 — "Доброй ночи".<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson09/task08_01.sql)

8. В таблице `products` есть два текстовых поля: name с названием товара и `description` с его описанием. 
Допустимо присутствие обоих полей или одно из них.
Ситуация, когда оба поля принимают неопределенное значение `NULL` неприемлема.
Используя триггеры, добейтесь того, чтобы одно из этих полей или оба поля были заполнены. 
При попытке присвоить полям `NULL`-значение необходимо отменить операцию.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson09/task08_02.sql)

9. (по желанию) Напишите хранимую функцию для вычисления произвольного числа Фибоначчи. 
Числами Фибоначчи называется последовательность в которой число равно сумме двух предыдущих чисел. 
Вызов функции `FIBONACCI(10)` должен возвращать число 55.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson09/task08_03.sql)


## Уроки 11 и 12. Оптимизация запросов. NoSQL
1. Создайте таблицу `logs` типа `Archive`. 
Пусть при каждом создании записи в таблицах `users`, `catalogs` и `products` 
в таблицу `logs` помещается время и дата создания записи, название таблицы, 
идентификатор первичного ключа и содержимое поля name.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson11/task09_01.sql)

2. (по желанию) Создайте SQL-запрос, который помещает в таблицу `users` миллион записей.<br>

3. В базе данных `Redis` подберите коллекцию для подсчета посещений с определенных IP-адресов.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson11/task10_01.sql)

4. При помощи базы данных `Redis` решите задачу поиска имени пользователя 
по электронному адресу и наоборот, поиск электронного адреса пользователя по его имени.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson11/task10_02.sql)
 
5. Организуйте хранение категорий и товарных позиций учебной базы данных `shop` в СУБД `MongoDB`.<br>
[Решение](https://github.com/bostspb/mysql/blob/master/Scripts/lesson11/task10_03.sql)


## Курсовая работа
Спроектированния БД предназначена для мультисайтовой CMS, управляющей кредитными витринами.
Витрина представляет собой таблицу с набором офферов (кредитных предложений) с реферальными ссылками.
Набор офферов на витрине зависит от тематики страницы (тип кредита, тег и т.п.) и региона (один сайт - один город).
Порядок расположения офферов на витрине зависит от EPC оффера, т.е. его доходности.
Помимо страниц с витринами, каждый сайт имеет служебные страницы, блог, справочник банков и новостной раздел под свой город.
 
За основу была взята существующая БД, которая не имеет внешних ключей, триггеров, хранимых процедур/функций и представлений.
Таким образом, в данном курсовом проекте осуществляется ее рефакторинг и оптимизация.

1. [DDL](https://github.com/bostspb/mysql/blob/master/Scripts/coursework/01_data_definition.sql)
2. [ER Diagram](https://github.com/bostspb/mysql/blob/master/Scripts/coursework/02_er_diagram.erd) в формате _DBeaver ERD_
3. [Наполнение базы данными](https://github.com/bostspb/mysql/blob/master/Scripts/coursework/03_filling_with_data.sql) осуществляется путем их переноса из старой базы
4. [Скрипты характерных выборок](https://github.com/bostspb/mysql/blob/master/Scripts/coursework/04_queries.sql)
5. [Представления](https://github.com/bostspb/mysql/blob/master/Scripts/coursework/05_views.sql)
6. [Процедуры, функции и триггеры](https://github.com/bostspb/mysql/blob/master/Scripts/coursework/06_procedures_triggers.sql)